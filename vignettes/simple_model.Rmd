---
title: "How to use the 'construct_nll' method"
author: "Phillip Brinck Vetter"
date: "2023-03-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ctsmrTMB)
```

## construct_nll

In this document we show how to use the \code{construct_nll} method of a \code{ctsmrTMB} class object to construct and extract the objective function handles. This gives the user direct access to the objective function, gradient and hessian (the latter is only available if the model does not contain any random effects parameters.). These are useful if for instance the user has a preferred optimizer, or wish to further customise the objective function.

We will use a random walk process to showcase the usage. We first generate some observation data

```{r}
# Create time vector
tvec = seq(0,100,by=1)

# Create data.frame
df = data.frame( t=tvec, y=rnorm(length(tvec),mean=0,sd=sqrt(diff(tvec))))
```

We then construct the model object

```{r}
# Create model object
model = ctsmrTMB$new()

# Set model name
model$set_modelname("randomwalk_test")

# Set cpp file directory
current.path = dirname(rstudioapi::documentPath())
cpp.path = paste(current.path, "/cppfiles", sep="")
model$set_cppfile_directory(cpp.path)
print(getwd())



# Add system equations
model$add_systems(dx ~ 0 * dt + exp(logsigma_x) * dw)

# Add observation equation
model$add_observations(y ~ x)

# Specify observation variance
model$add_observation_variances(y ~ exp(logsigma_y^2))

model$add_parameters(
  logsigma_x = log(c(init = 1, lower=1e-10, upper = 10)),
  logsigma_y = log(c(init = 1, lower=1e-10, upper = 10))
)

model$set_initial_state(mean=0, cov=diag(1))
```

The model is now setup and ready to be used. In a standard setting we will simply use the in-built optimisation by calling

```{r}
fit = model$estimate(data=df, ode.timestep=1e-1)
```



returns the This gives access to the object created when calling \code{TMB}'s} \code{MakeADFun} function.


This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
